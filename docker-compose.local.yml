version: '3.8'
services:
  kasmdiscordplexcontrol:
    build:
      context: .
      dockerfile: dockerfile-f00d4tehg0dz-kasm-discord-screenshare
    container_name: kasmdiscordplexcontrol
    ports:
      - "6901:6901"      # KasmVNC web interface
      - "8081:8081"      # Audio websocket
      - "4901:4901"      # Audio output
      - "8764:8764"      # Plex Discord WebSocket (for Firefox extension)
      - "8765:8765"      # Plex Discord WebSocket server (for Discord bot)
      - "8766:8766"      # WebSocket SSL Proxy
    environment:
      # VNC Configuration
      - VNC_PW=vncpassword
      - VNC_VIEW_ONLY_PW=viewonlypassword
      - VNC_COL_DEPTH=24
      - VNC_RESOLUTION=1280x720
      - MAX_FRAME_RATE=24

      # Kasm Services (disable unused ones)
      - KASM_SVC_AUDIO=1
      - KASM_SVC_AUDIO_INPUT=0
      - KASM_SVC_UPLOADS=0
      - KASM_SVC_GAMEPAD=0
      - KASM_SVC_WEBCAM=0
      - KASM_SVC_PRINTER=0

      # PipeWire Configuration
      - START_PIPEWIRE=1

      # Desktop Environment
      - START_XFCE4=1

      # Plex Configuration
      - IP=${PLEX_IP}
      - PORT=${PLEX_PORT}
      - PLEX_TOKEN=${PLEX_TOKEN}

    # Shared memory for browser/Discord
    shm_size: '512m'

    # Volumes - DON'T mount over /home/kasm-user or scripts won't work!
    volumes:
      # Persist user config (specific subdirectories only)
      - kasmdiscordplexcontrol_config:/home/kasm-user/.config
      - kasmdiscordplexcontrol_mozilla:/home/kasm-user/.mozilla
      - kasmdiscordplexcontrol_discord:/home/kasm-user/.config/discord

    # Network configuration
    network_mode: bridge

    # Security options for container compatibility
    cap_add:
      - SYS_ADMIN

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

    # Keep container running
    stdin_open: true
    tty: true

    # Restart policy
    restart: unless-stopped

volumes:
  kasmdiscordplexcontrol_config:
    driver: local
  kasmdiscordplexcontrol_mozilla:
    driver: local
  kasmdiscordplexcontrol_discord:
    driver: local